{% extends "main.html" %}
{% block content %}

<style>
/* POS: Remove number input spinners */
.no-spinner::-webkit-outer-spin-button,
.no-spinner::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
.no-spinner {
  -moz-appearance: textfield;
}

/* Column alignment */
.pos-item {
  text-align: left;
}
.pos-quantity {
  text-align: center;
}
.pos-discount {
  text-align: right;
}
.pos-quantity .btn,
.pos-discount .btn {
  width: 32px;
}
.pos-quantity input,
.pos-discount input {
  width: 60px;
  margin: 0 4px;
}
</style>

<div class="container py-3">

  <!-- PAGE HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h4 class="fw-semibold mb-1">
        <i class="bi bi-box-seam me-1 text-primary"></i>
        Edit Preset (POS)
      </h4>
      <small class="text-muted">Adjust quantities and discounts using + / − buttons</small>
    </div>
  </div>

  <form method="POST" action="{% url 'edit-preset' preset.id %}">
    {% csrf_token %}

    <!-- PRESET INFO CARD -->
    <div class="card border-0 shadow-sm rounded-4 mb-3">
      <div class="card-body d-flex flex-wrap align-items-center gap-3 py-3" style="min-height: 90px;">
        <div class="flex-grow-1" style="max-width: 360px;">
          <label class="small text-muted mb-1">Preset name</label>
          <input type="text"
                class="form-control form-control-sm"
                name="preset_{{ preset.id }}"
                value="{{ preset.name }}"
                placeholder="e.g. Weekly delivery bundle">
        </div>
        <div>
          <label class="small text-muted mb-1 d-block">Preset ID</label>
          <span class="badge text-bg-light px-3 py-2">{{ preset.id }}</span>
        </div>
        <div>
          <label class="small text-muted mb-1 d-block">Items in preset</label>
          <span class="badge text-bg-secondary px-3 py-2">{{ items|length }}</span>
        </div>
      </div>
    </div>

    <!-- ITEMS TABLE CARD -->
    <div class="card border-0 shadow-sm rounded-4">
      <div class="card-header bg-white py-2 px-3 d-flex justify-content-between align-items-center">
        <span class="fw-semibold small">
          Items in this preset
        </span>
        <small class="text-muted d-none d-sm-inline">
          POS-style controls for quantity and per-item discount
        </small>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light small text-uppercase">
              <tr>
                <th class="pos-item">Item</th>
                <th class="pos-quantity">Quantity</th>
                <th class="pos-discount">Discount</th>
              </tr>
            </thead>
            <tbody>
              {% for item in items %}
              <tr>
                <!-- ITEM NAME (left) -->
                <td class="pos-item" style="min-width: 200px;">
                  <div class="fw-semibold">{{ item.material.name }}</div>
                  <div class="small text-muted">
                    Material ID: {{ item.material.id }}
                  </div>
                </td>

                <!-- QUANTITY (center) -->
                <td class="pos-quantity">
                  <div class="d-inline-flex align-items-center">
                    <button type="button"
                            class="btn btn-outline-secondary btn-sm qty-btn"
                            data-target="quantity_{{ item.id }}" data-step="-1">−</button>
                    <input type="number"
                          class="form-control form-control-sm text-center no-spinner fw-semibold mx-1"
                          name="quantity_{{ item.id }}"
                          value="{{ item.quantity }}"
                          min="1" readonly>
                    <button type="button"
                            class="btn btn-outline-secondary btn-sm qty-btn"
                            data-target="quantity_{{ item.id }}" data-step="1">+</button>
                  </div>
                </td>

                <!-- DISCOUNT (right) -->
                <td class="pos-discount">
                  <div class="d-inline-flex align-items-center justify-content-end w-100">
                    <button type="button"
                            class="btn btn-outline-secondary btn-sm discount-btn"
                            data-target="discount_{{ item.id }}" data-step="-1">−</button>
                    <input type="number"
                          name="discount_{{ item.id }}"
                          class="form-control form-control-sm text-center no-spinner mx-1"
                          min="0" step="1"
                          value="{{ item.discount|floatformat:0 }}"
                          readonly>
                    <button type="button"
                            class="btn btn-outline-secondary btn-sm discount-btn"
                            data-target="discount_{{ item.id }}" data-step="1">+</button>
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="3" class="text-center py-4 text-muted">
                  No saved items found for this preset.
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- SAVE / CANCEL -->
    <div class="d-flex justify-content-end gap-2 mt-3">
      <a href="{% url 'preset-detail' preset.id %}" class="btn btn-light border btn-sm">
        Cancel
      </a>
      <button type="submit" class="btn btn-sm btn-primary">
        <i class="bi bi-check-circle me-1"></i>
        Save changes
      </button>
    </div>


<!-- POS + / - LOGIC -->
<script>
document.addEventListener('click', function(e) {
  // Quantity + - (min = 1)
  const qtyBtn = e.target.closest('.qty-btn');
  if (qtyBtn) {
    const inputName = qtyBtn.dataset.target;
    const step = parseInt(qtyBtn.dataset.step);
    const input = document.querySelector(`input[name="${inputName}"]`);
    let current = parseInt(input.value) || 1;
    current += step;
    if (current < 1) current = 1;
    input.value = current;
  }

  // Discount + - (min = 0)
  const discBtn = e.target.closest('.discount-btn');
  if (discBtn) {
    const inputName = discBtn.dataset.target;
    const step = parseInt(discBtn.dataset.step);
    const input = document.querySelector(`input[name="${inputName}"]`);
    let current = parseInt(input.value) || 0;
    current += step;
    if (current < 0) current = 0;
    input.value = current;
  }
});
</script>

{% endblock content %}
